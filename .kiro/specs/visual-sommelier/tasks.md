# План реализации

## Фаза 0: Proof of Concept - Тестирование работоспособности идеи

- [x] 0.1 Установка и проверка Ollama + LLaVA
  - Установить Ollama на систему
  - Загрузить модель llava:7b-v1.6-mistral-q4_0
  - Создать простой Python скрипт для тестирования LLaVA
  - Протестировать генерацию описания изображения бытового устройства
  - Проверить время отклика и качество ответов на русском языке
  - _Requirements: 11.1, 11.2_

- [x] 0.2 Тестирование YOLOv8n для детекции
  - Создать простой скрипт с YOLOv8n
  - Протестировать детекцию объектов на фото бытовых устройств
  - Проверить скорость инференса на Quadro P1000
  - Оценить точность детекции кнопок, переключателей, панелей
  - _Requirements: 1.1, 11.1_

- [x] 0.3 Тестирование EasyOCR
  - Создать скрипт для распознавания текста
  - Протестировать на фото с текстом на русском, английском, китайском
  - Проверить качество распознавания текста на кнопках устройств
  - Оценить скорость работы
  - _Requirements: 1.1, 5.3_

- [x] 0.4 Интеграционный POC тест
  - Создать простой end-to-end скрипт
  - Загрузить фото устройства (например, пульт или стиральная машина)
  - Запустить YOLOv8n для детекции элементов
  - Запустить EasyOCR для распознавания текста
  - Отправить изображение + вопрос в LLaVA
  - Получить объяснение на русском языке
  - Замерить общее время выполнения
  - Оценить использование GPU памяти
  - _Requirements: 1.1, 2.1, 2.2, 10.2, 10.3, 11.1_

- [x] 0.5 Документирование результатов POC
  - Создать отчет с результатами тестирования
  - Зафиксировать время инференса каждой модели
  - Зафиксировать использование VRAM
  - Оценить качество ответов LLaVA
  - Принять решение: продолжать разработку или корректировать подход
  - _Requirements: все_

## Фаза 1: Настройка проекта и базовая инфраструктура

- [x] 1. Инициализация проекта и настройка окружения
  - Создать структуру проекта с frontend (React + TypeScript) и backend (Python + FastAPI)
  - Настроить package.json и requirements.txt с необходимыми зависимостями
  - Настроить TypeScript, ESLint, Prettier для frontend
  - Настроить Black, isort, mypy для backend
  - Создать .env.example с шаблоном переменных окружения
  - _Requirements: 9.5_

- [x] 
2. Настройка базовых адаптеров для локальных моделей
  - Создать абстрактный интерфейс CVProviderAdapter
  - Создать абстрактный интерфейс LLMProviderAdapter
  - Реализовать YOLOAdapter с базовыми методами детекции
  - Реализовать EasyOCRAdapter для распознавания текста
  - Реализовать LLaVAAdapter через Ollama
  - Добавить конфигурацию для переключения между провайдерами
  - Добавить GPU memory management и model loading/unloading
  - _Requirements: 9.1, 9.2, 9.4, 11.1, 11.2_

- [ ]* 2.1 Написать property-тест для адаптеров
  - **Property 1: Обработка изображений устройств**
  - **Validates: Requirements 1.1**

- [x] 2.2 Настройка GPU и проверка CUDA
  - Создать утилиту для проверки доступности CUDA
  - Реализовать GPU memory monitor
  - Настроить автоматическую загрузку моделей в GPU
  - Добавить fallback на CPU если GPU недоступна
  - Реализовать логирование GPU статистики
  - _Requirements: 11.1, 11.2, 11.6, 11.7_

- [ ]* 2.3 Написать тесты для GPU utilities
  - Тест проверки CUDA
  - Тест мониторинга памяти
  - Тест загрузки/выгрузки моделей

## Фаза 2: Backend - Основные сервисы

- [ ] 3. Реализация моделей данных
  - Создать Pydantic модели: DeviceAnalysisResult, Control, BoundingBox
  - Создать модели: Message, Session, DeviceContext, Explanation, Step
  - Добавить валидацию для всех моделей
  - _Requirements: 1.1, 1.2, 2.3, 3.2_

- [ ]* 3.1 Написать unit-тесты для моделей данных
  - Тесты валидации полей
  - Тесты сериализации/десериализации

- [ ] 4. Реализация ImageAnalysisService
  - Реализовать метод analyze_device для идентификации устройств
  - Реализовать метод detect_controls для обнаружения элементов управления
  - Реализовать метод highlight_area для выделения областей
  - Добавить логику определения уверенности распознавания
  - Добавить обработку низкой уверенности с предложением категорий
  - _Requirements: 1.1, 1.2, 1.3, 2.4_

- [ ]* 4.1 Написать property-тест для распознавания устройств
  - **Property 2: Отображение результатов распознавания**
  - **Validates: Requirements 1.2**

- [ ]* 4.2 Написать property-тест для низкой уверенности
  - **Property 3: Предложение категорий при низкой уверенности**
  - **Validates: Requirements 1.3**

- [ ]* 4.3 Написать property-тест для идентификации по координатам
  - **Property 7: Идентификация элемента по координатам**
  - **Validates: Requirements 2.4**

- [ ] 5. Реализация ExplanationService
  - Реализовать метод generate_explanation с поддержкой мультиязычности
  - Реализовать метод generate_instructions для пошаговых инструкций
  - Реализовать метод clarify_step для дополнительных разъяснений
  - Добавить логику добавления предупреждений о безопасности
  - Добавить дисклеймер ко всем ответам
  - _Requirements: 2.1, 2.2, 2.3, 3.1, 3.5, 8.1, 8.2, 8.5_

- [ ]* 5.1 Написать property-тест для соответствия языка
  - **Property 5: Соответствие языка ответа**
  - **Validates: Requirements 2.2, 5.4**

- [ ]* 5.2 Написать property-тест для структуры объяснения
  - **Property 6: Структура объяснения**
  - **Validates: Requirements 2.3**

- [ ]* 5.3 Написать property-тест для генерации инструкций
  - **Property 9: Генерация структурированных инструкций**
  - **Validates: Requirements 3.1, 3.2**

- [ ]* 5.4 Написать property-тест для предупреждений безопасности
  - **Property 23: Предупреждения о безопасности для опасных операций**
  - **Validates: Requirements 8.1**

- [ ]* 5.5 Написать property-тест для электрических устройств
  - **Property 24: Предупреждения для электрических устройств**
  - **Validates: Requirements 8.2**

- [ ]* 5.6 Написать property-тест для дисклеймера
  - **Property 27: Наличие дисклеймера**
  - **Validates: Requirements 8.5**

- [ ] 6. Реализация SessionService
  - Реализовать метод create_session для создания новых сессий
  - Реализовать метод add_message для добавления сообщений
  - Реализовать метод get_session_context для получения контекста
  - Добавить поддержку истории диалога в рамках сессии
  - _Requirements: 2.5, 6.1_

- [ ]* 6.1 Написать property-тест для контекста сессии
  - **Property 8: Сохранение контекста сессии**
  - **Validates: Requirements 2.5**

## Фаза 3: Backend - API endpoints

- [ ] 7. Создание FastAPI приложения и endpoints
  - Настроить FastAPI приложение с CORS
  - Создать endpoint POST /api/analyze для анализа изображений
  - Создать endpoint POST /api/explain для генерации объяснений
  - Создать endpoint POST /api/instructions для генерации инструкций
  - Создать endpoint POST /api/clarify для уточнений по шагам
  - Добавить валидацию входных данных
  - Добавить обработку ошибок и таймаутов
  - _Requirements: 1.1, 2.1, 3.1, 3.5, 10.1, 10.2, 10.3_

- [ ]* 7.1 Написать property-тесты для производительности
  - **Property 28: Время начала обработки**
  - **Property 29: Время распознавания**
  - **Property 30: Время генерации объяснения**
  - **Validates: Requirements 10.1, 10.2, 10.3**

- [ ]* 7.2 Написать integration-тесты для API
  - Тест полного flow: загрузка → распознавание → вопрос → ответ
  - Тест обработки ошибок

## Фаза 4: Frontend - Базовые компоненты

- [ ] 8. Настройка React приложения и роутинга
  - Создать React приложение с Vite
  - Настроить Tailwind CSS
  - Настроить Zustand для управления состоянием
  - Создать базовую структуру страниц (Home, History, Settings)
  - Настроить роутинг между страницами
  - _Requirements: 5.1, 6.2_

- [ ] 9. Реализация CameraCapture компонента
  - Реализовать доступ к камере через WebRTC API
  - Реализовать захват одиночного изображения
  - Реализовать переключение между камерами
  - Добавить проверку качества изображения
  - Добавить обработку ошибок доступа к камере
  - _Requirements: 1.4, 4.1_

- [ ] 10. Реализация ImageUploader компонента
  - Реализовать выбор изображения из галереи
  - Добавить валидацию формата и размера
  - Реализовать сжатие изображений перед отправкой
  - _Requirements: 1.1, 10.5_

- [ ]* 10.1 Написать property-тест для сжатия изображений
  - **Property 32: Сжатие изображений**
  - **Validates: Requirements 10.5**

- [ ] 11. Реализация DeviceIdentifier компонента
  - Отображение результатов идентификации устройства
  - Отображение уровня уверенности
  - Реализовать ручной выбор категории при низкой уверенности
  - _Requirements: 1.2, 1.3_

## Фаза 5: Frontend - Интерактивные компоненты

- [ ] 12. Реализация ExplanationView компонента
  - Отображение текстовых объяснений
  - Отображение пошаговых инструкций
  - Реализовать отметку шагов как выполненных
  - Отображение предупреждений о безопасности
  - Отображение визуальных выделений на изображении (bounding boxes)
  - Добавить кнопку для запроса дополнительных разъяснений
  - _Requirements: 2.3, 3.2, 3.3, 3.4, 3.5, 8.3_

- [ ]* 12.1 Написать property-тест для отметки шагов
  - **Property 10: Отметка выполнения шагов**
  - **Validates: Requirements 3.3**

- [ ]* 12.2 Написать property-тест для визуального выделения
  - **Property 11: Визуальное выделение элементов**
  - **Validates: Requirements 3.4**

- [ ]* 12.3 Написать property-тест для дополнительных разъяснений
  - **Property 12: Дополнительные разъяснения шагов**
  - **Validates: Requirements 3.5**

- [ ]* 12.4 Написать property-тест для визуального выделения опасных шагов
  - **Property 25: Визуальное выделение опасных шагов**
  - **Validates: Requirements 8.3**

- [ ] 13. Реализация режима реального времени
  - Реализовать потоковую обработку кадров с камеры
  - Добавить отображение визуальных меток для обнаруженных элементов
  - Реализовать фиксацию кадра по клику
  - Добавить рекомендации по улучшению качества изображения
  - Обеспечить частоту обработки минимум 1 FPS
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ]* 13.1 Написать property-тест для частоты обработки
  - **Property 13: Частота обработки кадров в реальном времени**
  - **Validates: Requirements 4.2**

- [ ]* 13.2 Написать property-тест для визуальных меток
  - **Property 14: Визуальные метки обнаруженных элементов**
  - **Validates: Requirements 4.3**

- [ ]* 13.3 Написать property-тест для фиксации кадра
  - **Property 15: Фиксация кадра при взаимодействии**
  - **Validates: Requirements 4.4**

## Фаза 6: Локальное хранилище и история

- [ ] 14. Реализация IndexedDB хранилища
  - Настроить IndexedDB с тремя stores: Sessions, Cache, Settings
  - Реализовать методы сохранения и загрузки сессий
  - Реализовать сжатие изображений для миниатюр
  - Реализовать методы работы с кэшем
  - _Requirements: 6.1, 6.5, 7.5_

- [ ] 15. Реализация HistoryManager компонента
  - Отображение списка всех сессий с миниатюрами
  - Реализовать восстановление сессии по клику
  - Реализовать удаление сессий
  - Добавить поиск по истории
  - _Requirements: 6.2, 6.3, 6.4_

- [ ]* 15.1 Написать property-тест для round-trip сессий
  - **Property 18: Round-trip сохранения сессии**
  - **Validates: Requirements 6.1, 6.3**

- [ ]* 15.2 Написать property-тест для отображения истории
  - **Property 19: Отображение истории сессий**
  - **Validates: Requirements 6.2**

- [ ]* 15.3 Написать property-тест для удаления сессий
  - **Property 20: Удаление сессии**
  - **Validates: Requirements 6.4**

## Фаза 7: Мультиязычность и локализация

- [ ] 16. Реализация системы локализации
  - Создать файлы переводов для русского, английского, китайского
  - Реализовать LanguageManager для управления языком
  - Реализовать автоопределение языка устройства при первом запуске
  - Реализовать переключение языка в настройках
  - Добавить форматирование дат, чисел, единиц измерения по локали
  - _Requirements: 5.1, 5.2, 5.3, 5.5_

- [ ]* 16.1 Написать property-тест для обновления языка
  - **Property 16: Обновление языка интерфейса**
  - **Validates: Requirements 5.2**

- [ ]* 16.2 Написать property-тест для локализации форматов
  - **Property 17: Локализация форматов**
  - **Validates: Requirements 5.5**

## Фаза 8: Оптимизация GPU и кэширование

- [ ] 17. Оптимизация использования GPU
  - Реализовать batch processing для CV операций
  - Добавить model quantization (4-bit) для LLM
  - Реализовать mixed precision (FP16) для CV моделей
  - Добавить lazy loading моделей
  - Реализовать автоматическую выгрузку неиспользуемых моделей
  - Добавить мониторинг GPU памяти и утилизации
  - _Requirements: 11.3, 11.4, 11.6, 11.7_

- [ ]* 17.1 Написать property-тест для batch processing
  - **Property 33: Эффективность batch processing**
  - **Validates: Requirements 11.4**

- [ ]* 17.2 Написать property-тест для model unloading
  - **Property 34: Автоматическая выгрузка моделей**
  - **Validates: Requirements 11.6**

- [ ] 18. Реализация CacheManager и офлайн режима
  - Реализовать кэширование ответов LLM
  - Реализовать кэширование результатов CV
  - Добавить TTL для кэша (24 часа)
  - Реализовать очистку устаревшего кэша
  - Убедиться что все операции работают локально без интернета
  - _Requirements: 7.1, 7.3, 7.5, 11.5_

- [ ]* 18.1 Написать integration-тест для офлайн режима
  - Тест полного flow без интернета
  - Тест всех CV операций локально
  - Тест всех LLM операций через Ollama

## Фаза 9: Безопасность и производительность

- [ ] 19. Добавление мер безопасности
  - Добавить rate limiting на backend
  - Настроить CORS для production
  - Добавить валидацию и санитизацию всех входных данных
  - Настроить Content Security Policy
  - Добавить защиту от injection атак
  - _Requirements: 8.4, 8.5_

- [ ]* 19.1 Написать property-тест для рекомендаций ремонта
  - **Property 26: Рекомендации для ремонта**
  - **Validates: Requirements 8.4**

- [ ] 20. Оптимизация производительности UI
  - Добавить debouncing для пользовательского ввода
  - Реализовать lazy loading для истории
  - Оптимизировать рендеринг списков (виртуализация)
  - Обеспечить отклик интерфейса < 200ms
  - _Requirements: 10.4_

- [ ]* 20.1 Написать property-тест для времени отклика UI
  - **Property 31: Время отклика интерфейса**
  - **Validates: Requirements 10.4**

## Фаза 10: Тестирование и документация

- [ ] 21. Настройка тестового окружения
  - Настроить Jest и React Testing Library для frontend
  - Настроить pytest для backend
  - Настроить Hypothesis для property-based тестов (Python)
  - Настроить fast-check для property-based тестов (TypeScript)
  - Настроить Playwright для E2E тестов
  - _Requirements: все_

- [ ]* 22. Написать E2E тесты
  - Тест первого запуска и выбора языка
  - Тест захвата изображения через камеру
  - Тест загрузки изображения из галереи
  - Тест диалога с системой
  - Тест работы с историей
  - Тест офлайн-режима

- [ ] 23. Checkpoint - Убедиться, что все тесты проходят
  - Ensure all tests pass, ask the user if questions arise.

## Фаза 11: Развертывание

- [ ] 24. Подготовка к развертыванию
  - Создать Dockerfile для backend
  - Настроить CI/CD pipeline (GitHub Actions)
  - Настроить переменные окружения для production
  - Создать документацию по развертыванию
  - _Requirements: все_

- [ ] 25. Развертывание приложения
  - Развернуть frontend на Vercel/Netlify
  - Развернуть backend на Cloud Run/Heroku
  - Настроить мониторинг и логирование
  - Провести smoke-тесты на production
  - _Requirements: все_

- [ ] 26. Final Checkpoint - Финальная проверка
  - Ensure all tests pass, ask the user if questions arise.
